# Migration `20191002152800-init-auth`

This migration has been generated by kiralybalint <balint.kiraly@cogito.study> at 10/2/2019, 3:28:00 PM.
You can check out the [state of the datamodel](./datamodel.prisma) after the migration.

## Database Steps

```sql
CREATE TABLE "public"."DepartmentPermission" (
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "deletedAt" timestamp(3)   ,
  "id" text NOT NULL  ,
  "type" text NOT NULL DEFAULT 'UPDATE_DEPARTMENT' ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "public"."InstitutePermission" (
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "deletedAt" timestamp(3)   ,
  "id" text NOT NULL  ,
  "type" text NOT NULL DEFAULT 'UPDATE_INSTITUTE' ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "public"."NoteCommentPermission" (
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "deletedAt" timestamp(3)   ,
  "id" text NOT NULL  ,
  "type" text NOT NULL DEFAULT 'UPDATE' ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "public"."NoteCommentThreadPermission" (
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "deletedAt" timestamp(3)   ,
  "id" text NOT NULL  ,
  "type" text NOT NULL DEFAULT 'UPDATE' ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "public"."NoteHighlightPermission" (
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "deletedAt" timestamp(3)   ,
  "id" text NOT NULL  ,
  "type" text NOT NULL DEFAULT 'UPDATE' ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "public"."NotePermission" (
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "deletedAt" timestamp(3)   ,
  "id" text NOT NULL  ,
  "type" text NOT NULL DEFAULT 'UPDATE' ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "public"."Permission" (
  "id" text NOT NULL  ,
  PRIMARY KEY ("id")
);

CREATE TABLE "public"."SubjectPermission" (
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "deletedAt" timestamp(3)   ,
  "id" text NOT NULL  ,
  "type" text NOT NULL DEFAULT 'UPDATE_SUBJECT' ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "public"."SubjectInformationPermission" (
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "deletedAt" timestamp(3)   ,
  "id" text NOT NULL  ,
  "type" text NOT NULL DEFAULT 'UPDATE' ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "public"."SuggestionPermission" (
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "deletedAt" timestamp(3)   ,
  "id" text NOT NULL  ,
  "type" text NOT NULL DEFAULT 'UPDATE_SUGGESTION' ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "public"."UserPermission" (
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "deletedAt" timestamp(3)   ,
  "id" text NOT NULL  ,
  "type" text NOT NULL DEFAULT 'UPDATE_USER' ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "public"."UserGroup" (
  "id" text NOT NULL  ,
  "name" text NOT NULL DEFAULT '' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "public"."_UserGroups" (
  "A" text   REFERENCES "public"."User"("id") ON DELETE CASCADE,
  "B" text   REFERENCES "public"."UserGroup"("id") ON DELETE CASCADE
);

CREATE TABLE "public"."_PermissionToUser" (
  "A" text   REFERENCES "public"."Permission"("id") ON DELETE CASCADE,
  "B" text   REFERENCES "public"."User"("id") ON DELETE CASCADE
);

CREATE TABLE "public"."_UserGroupPermissions" (
  "A" text   REFERENCES "public"."Permission"("id") ON DELETE CASCADE,
  "B" text   REFERENCES "public"."UserGroup"("id") ON DELETE CASCADE
);

ALTER TABLE "public"."Department" ADD COLUMN "departmentPermission" text   REFERENCES "public"."DepartmentPermission"("id") ON DELETE SET NULL;

ALTER TABLE "public"."Institute" ADD COLUMN "institutePermission" text   REFERENCES "public"."InstitutePermission"("id") ON DELETE SET NULL;

ALTER TABLE "public"."Note" ADD COLUMN "notePermission" text   REFERENCES "public"."NotePermission"("id") ON DELETE SET NULL;

ALTER TABLE "public"."NoteComment" ADD COLUMN "noteCommentPermission" text   REFERENCES "public"."NoteCommentPermission"("id") ON DELETE SET NULL;

ALTER TABLE "public"."NoteCommentThread" ADD COLUMN "noteCommentThreadPermission" text   REFERENCES "public"."NoteCommentThreadPermission"("id") ON DELETE SET NULL;

ALTER TABLE "public"."NoteHighlight" ADD COLUMN "noteHighlightPermission" text   REFERENCES "public"."NoteHighlightPermission"("id") ON DELETE SET NULL;

ALTER TABLE "public"."Subject" ADD COLUMN "subjectPermission" text   REFERENCES "public"."SubjectPermission"("id") ON DELETE SET NULL;

ALTER TABLE "public"."SubjectInformation" ADD COLUMN "subjectInformationPermission" text   REFERENCES "public"."SubjectInformationPermission"("id") ON DELETE SET NULL;

ALTER TABLE "public"."Suggestion" ADD COLUMN "suggestionPermission" text   REFERENCES "public"."SuggestionPermission"("id") ON DELETE SET NULL;

ALTER TABLE "public"."User" ADD COLUMN "userPermission" text   REFERENCES "public"."UserPermission"("id") ON DELETE SET NULL;

ALTER TABLE "public"."DepartmentPermission" ADD COLUMN "permission" text   REFERENCES "public"."Permission"("id") ON DELETE SET NULL;

ALTER TABLE "public"."InstitutePermission" ADD COLUMN "permission" text   REFERENCES "public"."Permission"("id") ON DELETE SET NULL;

ALTER TABLE "public"."NoteCommentPermission" ADD COLUMN "permission" text   REFERENCES "public"."Permission"("id") ON DELETE SET NULL;

ALTER TABLE "public"."NoteCommentThreadPermission" ADD COLUMN "permission" text   REFERENCES "public"."Permission"("id") ON DELETE SET NULL;

ALTER TABLE "public"."NoteHighlightPermission" ADD COLUMN "permission" text   REFERENCES "public"."Permission"("id") ON DELETE SET NULL;

ALTER TABLE "public"."NotePermission" ADD COLUMN "permission" text   REFERENCES "public"."Permission"("id") ON DELETE SET NULL;

ALTER TABLE "public"."Permission" ADD COLUMN "subjectInformationPermission" text   REFERENCES "public"."SubjectInformationPermission"("id") ON DELETE SET NULL,
ADD COLUMN "subjectPermission" text   REFERENCES "public"."SubjectPermission"("id") ON DELETE SET NULL,
ADD COLUMN "suggestionPermission" text   REFERENCES "public"."SuggestionPermission"("id") ON DELETE SET NULL,
ADD COLUMN "userPermission" text   REFERENCES "public"."UserPermission"("id") ON DELETE SET NULL;

CREATE UNIQUE INDEX "DepartmentPermission.id" ON "public"."DepartmentPermission"("id")

CREATE UNIQUE INDEX "InstitutePermission.id" ON "public"."InstitutePermission"("id")

CREATE UNIQUE INDEX "NoteCommentPermission.id" ON "public"."NoteCommentPermission"("id")

CREATE UNIQUE INDEX "NoteCommentThreadPermission.id" ON "public"."NoteCommentThreadPermission"("id")

CREATE UNIQUE INDEX "NoteHighlightPermission.id" ON "public"."NoteHighlightPermission"("id")

CREATE UNIQUE INDEX "NotePermission.id" ON "public"."NotePermission"("id")

CREATE UNIQUE INDEX "Permission.id" ON "public"."Permission"("id")

CREATE UNIQUE INDEX "SubjectPermission.id" ON "public"."SubjectPermission"("id")

CREATE UNIQUE INDEX "SubjectInformationPermission.id" ON "public"."SubjectInformationPermission"("id")

CREATE UNIQUE INDEX "SuggestionPermission.id" ON "public"."SuggestionPermission"("id")

CREATE UNIQUE INDEX "UserPermission.id" ON "public"."UserPermission"("id")

CREATE UNIQUE INDEX "UserGroup.id" ON "public"."UserGroup"("id")

CREATE UNIQUE INDEX "_UserGroups_AB_unique" ON "public"."_UserGroups"("A","B")

CREATE UNIQUE INDEX "_PermissionToUser_AB_unique" ON "public"."_PermissionToUser"("A","B")

CREATE UNIQUE INDEX "_UserGroupPermissions_AB_unique" ON "public"."_UserGroupPermissions"("A","B")
```

## Changes

```diff
diff --git datamodel.mdl datamodel.mdl
migration 20190911151330-add-language..20191002152800-init-auth
--- datamodel.dml
+++ datamodel.dml
@@ -163,8 +163,9 @@
   phoneNumber         String?
   identifier          String
   isActive            Boolean         @default(false)
   role                UserRole        @relation(name: "UserRole")
+  groups              UserGroup[]     @relation(name: "UserGroups")
   notes               Note[]          @relation(name: "NoteAuthors")
   noteHighlights      NoteHighlight[] @relation(name: "UserNoteHighlights")
   suggestions         Suggestion[]    @relation(name: "SuggestionAuthor")
   approvedSuggestions Suggestion[]    @relation(name: "SuggestionApprovedBy")
@@ -176,9 +177,10 @@
   likedSuggestions    Suggestion[]    @relation(name: "SuggestionLikers")
   passwordToken       PasswordToken?  @relation(name: "PasswordTokenUser")
   departments         Department[]    @relation(name: "DepartmentLeader")
   institutes          Institute[]     @relation(name: "InstituteUsers")
-  preferredLanguage   Language?      @relation(name: "UserPrefferedLanguage")
+  preferredLanguage   Language?       @relation(name: "UserPrefferedLanguage")
+  permissions         Permission[]    @relation
   createdAt           DateTime        @default(now())
   updatedAt           DateTime        @updatedAt
   deletedAt           DateTime?
 }
@@ -191,4 +193,167 @@
   createdAt DateTime     @default(now())
   updatedAt DateTime     @updatedAt
   deletedAt DateTime?
 }
+
+model DepartmentPermission {
+  id        String                   @default(cuid()) @id @unique
+  type      DepartmentPermissionType
+  objects   Department[]             @relation
+  createdAt DateTime                 @default(now())
+  updatedAt DateTime                 @updatedAt
+  deletedAt DateTime?
+}
+
+enum DepartmentPermissionType {
+  UPDATE_DEPARTMENT
+  CREATE_SUBJECT
+}
+
+model InstitutePermission {
+  id        String                  @default(cuid()) @id @unique
+  type      InstitutePermissionType
+  objects   Institute[]             @relation
+  createdAt DateTime                @default(now())
+  updatedAt DateTime                @updatedAt
+  deletedAt DateTime?
+}
+
+enum InstitutePermissionType {
+  UPDATE_INSTITUTE
+  CREATE_DEPARTMENT
+}
+
+model NoteCommentPermission {
+  id        String                    @default(cuid()) @id @unique
+  type      NoteCommentPermissionType
+  objects   NoteComment[]             @relation
+  createdAt DateTime                  @default(now())
+  updatedAt DateTime                  @updatedAt
+  deletedAt DateTime?
+}
+
+enum NoteCommentPermissionType {
+  UPDATE
+  DELETE
+}
+
+model NoteCommentThreadPermission {
+  id        String                          @default(cuid()) @id @unique
+  type      NoteCommentThreadPermissionType
+  objects   NoteCommentThread[]             @relation
+  createdAt DateTime                        @default(now())
+  updatedAt DateTime                        @updatedAt
+  deletedAt DateTime?
+}
+
+enum NoteCommentThreadPermissionType {
+  UPDATE
+  DELETE
+}
+
+model NoteHighlightPermission {
+  id        String                      @default(cuid()) @id @unique
+  type      NoteHighlightPermissionType
+  objects   NoteHighlight[]             @relation
+  createdAt DateTime                    @default(now())
+  updatedAt DateTime                    @updatedAt
+  deletedAt DateTime?
+}
+
+enum NoteHighlightPermissionType {
+  UPDATE
+  DELETE
+}
+
+model NotePermission {
+  id        String             @default(cuid()) @id @unique
+  type      NotePermissionType
+  objects   Note[]             @relation
+  createdAt DateTime           @default(now())
+  updatedAt DateTime           @updatedAt
+  deletedAt DateTime?
+}
+
+enum NotePermissionType {
+  UPDATE
+  APPROVE_SUGGESTION
+  CREATE_SUGGESTION
+  DECLINE_SUGGESTION
+}
+
+model Permission {
+  id                           String                        @default(cuid()) @id @unique
+  userGroups                   UserGroup[]                   @relation(name: "UserGroupPermissions")
+  users                        User[]                        @relation
+  departmentPermission         DepartmentPermission?         @relation
+  institutePermission          InstitutePermission?          @relation
+  notePermission               NotePermission?               @relation
+  noteCommentPermission        NoteCommentPermission?        @relation
+  noteCommentThreadPermission  NoteCommentThreadPermission?  @relation
+  noteHighlightPermission      NoteHighlightPermission?      @relation
+  subjectPermission            SubjectPermission?            @relation
+  subjectInformationPermission SubjectInformationPermission? @relation
+  suggestionPermission         SuggestionPermission?         @relation
+  userPermission               UserPermission?               @relation
+}
+
+model SubjectPermission {
+  id        String                @default(cuid()) @id @unique
+  type      SubjectPermissionType
+  objects   Subject[]             @relation
+  createdAt DateTime              @default(now())
+  updatedAt DateTime              @updatedAt
+  deletedAt DateTime?
+}
+
+enum SubjectPermissionType {
+  UPDATE_SUBJECT
+  CREATE_NOTE
+}
+
+model SubjectInformationPermission {
+  id        String                           @default(cuid()) @id @unique
+  type      SubjectInformationPermissionType
+  objects   SubjectInformation[]             @relation
+  createdAt DateTime                         @default(now())
+  updatedAt DateTime                         @updatedAt
+  deletedAt DateTime?
+}
+
+enum SubjectInformationPermissionType {
+  UPDATE
+}
+
+model SuggestionPermission {
+  id        String                   @default(cuid()) @id @unique
+  type      SuggestionPermissionType
+  objects   Suggestion[]             @relation
+  createdAt DateTime                 @default(now())
+  updatedAt DateTime                 @updatedAt
+  deletedAt DateTime?
+}
+
+enum SuggestionPermissionType {
+  UPDATE_SUGGESTION
+  CREATE_NOTE
+}
+
+model UserPermission {
+  id        String             @default(cuid()) @id @unique
+  type      UserPermissionType
+  objects   User[]             @relation
+  createdAt DateTime           @default(now())
+  updatedAt DateTime           @updatedAt
+  deletedAt DateTime?
+}
+
+enum UserPermissionType {
+  UPDATE_USER
+}
+
+model UserGroup {
+  id          String       @default(cuid()) @id @unique
+  name        String
+  permissions Permission[] @relation(name: "UserGroupPermissions")
+  users       User[]       @relation(name: "UserGroups")
+}
```

## Photon Usage

You can use a specific Photon built for this migration (20191002152800-init-auth)
in your `before` or `after` migration script like this:

```ts
import Photon from '@generated/photon/20191002152800-init-auth'

const photon = new Photon()

async function main() {
  const result = await photon.users()
  console.dir(result, { depth: null })
}

main()

```
