# Migration `20191202145847-add-faculty-and-major`

This migration has been generated by kiralybalint <balint.kiraly@cogito.study> at 12/2/2019, 2:58:47 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TABLE "public"."Faculty" (
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "deletedAt" timestamp(3)   ,
  "id" text NOT NULL  ,
  "institute" text NOT NULL  REFERENCES "public"."Institute"("id") ON DELETE RESTRICT,
  "name" text NOT NULL DEFAULT '' ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "public"."Major" (
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "deletedAt" timestamp(3)   ,
  "id" text NOT NULL  ,
  "name" text NOT NULL DEFAULT '' ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "public"."FacultyPermission" (
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "deletedAt" timestamp(3)   ,
  "id" text NOT NULL  ,
  "type" text NOT NULL DEFAULT 'UPDATE_FACULTY' ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "public"."MajorPermission" (
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "deletedAt" timestamp(3)   ,
  "id" text NOT NULL  ,
  "type" text NOT NULL DEFAULT 'UPDATE_MAJOR' ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "public"."_MajorSubjects" (
  "A" text NOT NULL  REFERENCES "public"."Major"("id") ON DELETE CASCADE,
  "B" text NOT NULL  REFERENCES "public"."Subject"("id") ON DELETE CASCADE
);

ALTER TABLE "public"."User" ADD COLUMN "facultyPermission" text   REFERENCES "public"."FacultyPermission"("id") ON DELETE SET NULL,
ADD COLUMN "majorPermission" text   REFERENCES "public"."MajorPermission"("id") ON DELETE SET NULL;

ALTER TABLE "public"."Major" ADD COLUMN "faculty" text NOT NULL  REFERENCES "public"."Faculty"("id") ON DELETE RESTRICT;

ALTER TABLE "public"."FacultyPermission" ADD COLUMN "object" text NOT NULL  REFERENCES "public"."Faculty"("id") ON DELETE RESTRICT;

ALTER TABLE "public"."MajorPermission" ADD COLUMN "object" text NOT NULL  REFERENCES "public"."Major"("id") ON DELETE RESTRICT;

CREATE UNIQUE INDEX "Faculty.id" ON "public"."Faculty"("id")

CREATE UNIQUE INDEX "Major.id" ON "public"."Major"("id")

CREATE UNIQUE INDEX "FacultyPermission.id" ON "public"."FacultyPermission"("id")

CREATE UNIQUE INDEX "MajorPermission.id" ON "public"."MajorPermission"("id")

CREATE UNIQUE INDEX "_MajorSubjects_AB_unique" ON "public"."_MajorSubjects"("A","B")
```

## Changes

```diff
diff --git datamodel.mdl datamodel.mdl
migration 20191127191141-re-init..20191202145847-add-faculty-and-major
--- datamodel.dml
+++ datamodel.dml
@@ -1,6 +1,6 @@
 datasource postgres {
-  url = "***"
+  url      = env("POSTGRESQL_URL")
   provider = "postgres"
 }
 generator photon {
@@ -30,11 +30,23 @@
   updatedAt   DateTime               @updatedAt
   deletedAt   DateTime?
 }
+model Faculty {
+  id          String              @default(cuid()) @id @unique
+  name        String
+  institute   Institute           @relation(name: "InstituteFaculties")
+  majors      Major[]             @relation(name: "FacultyMajors")
+  permissions FacultyPermission[] @relation(name: "FacultyPermissions")
+  createdAt   DateTime            @default(now())
+  updatedAt   DateTime            @updatedAt
+  deletedAt   DateTime?
+}
+
 model Institute {
   id          String                @default(cuid()) @id @unique
   name        String
+  faculties   Faculty[]             @relation(name: "InstituteFaculties")
   departments Department[]          @relation(name: "DepartmentInstitute")
   users       User[]                @relation(name: "InstituteUsers")
   permissions InstitutePermission[] @relation(name: "InstitutePermissions")
   createdAt   DateTime              @default(now())
@@ -49,8 +61,19 @@
   users    User[]    @relation(name: "UserPrefferedLanguage")
   subjects Subject[] @relation(name: "SubjectLanguage")
 }
+model Major {
+  id          String            @default(cuid()) @id @unique
+  name        String
+  faculty     Faculty           @relation(name: "FacultyMajors")
+  subjects    Subject[]         @relation(name: "MajorSubjects")
+  permissions MajorPermission[] @relation(name: "MajorPermissions")
+  createdAt   DateTime          @default(now())
+  updatedAt   DateTime          @updatedAt
+  deletedAt   DateTime?
+}
+
 model Note {
   id             String              @default(cuid()) @id @unique
   content        String
   contentHTML    String
@@ -126,8 +149,9 @@
   informations SubjectInformation[] @relation(name: "SubjectInformations")
   notes        Note[]               @relation(name: "SubjectNotes")
   posts        Post[]               @relation(name: "SubjectPosts")
   language     Language             @relation(name: "SubjectLanguage")
+  majors       Major[]              @relation(name: "MajorSubjects")
   permissions  SubjectPermission[]  @relation(name: "SubjectPermissions")
   createdAt    DateTime             @default(now())
   updatedAt    DateTime             @updatedAt
   deletedAt    DateTime?
@@ -262,8 +286,24 @@
   DELETE_DEPARTMENT
   CREATE_SUBJECT
 }
+model FacultyPermission {
+  id        String                @default(cuid()) @id @unique
+  type      FacultyPermissionType
+  users     User[]                @relation
+  object    Faculty               @relation(name: "FacultyPermissions")
+  createdAt DateTime              @default(now())
+  updatedAt DateTime              @updatedAt
+  deletedAt DateTime?
+}
+
+enum FacultyPermissionType {
+  UPDATE_FACULTY
+  READ_FACULTY
+  DELETE_FACULTY
+}
+
 model InstitutePermission {
   id        String                  @default(cuid()) @id @unique
   type      InstitutePermissionType
   users     User[]                  @relation
@@ -278,8 +318,24 @@
   DELETE_INSTITUTE
   CREATE_DEPARTMENT
 }
+model MajorPermission {
+  id        String              @default(cuid()) @id @unique
+  type      MajorPermissionType
+  users     User[]              @relation
+  object    Major               @relation(name: "MajorPermissions")
+  createdAt DateTime            @default(now())
+  updatedAt DateTime            @updatedAt
+  deletedAt DateTime?
+}
+
+enum MajorPermissionType {
+  UPDATE_MAJOR
+  READ_MAJOR
+  DELETE_MAJOR
+}
+
 model NoteCommentPermission {
   id        String                    @default(cuid()) @id @unique
   type      NoteCommentPermissionType
   users     User[]                    @relation
```

## Photon Usage

You can use a specific Photon built for this migration (20191202145847-add-faculty-and-major)
in your `before` or `after` migration script like this:

```ts
import Photon from '@generated/photon/20191202145847-add-faculty-and-major'

const photon = new Photon()

async function main() {
  const result = await photon.users()
  console.dir(result, { depth: null })
}

main()

```
