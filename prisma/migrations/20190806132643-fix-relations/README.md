# Migration `20190806132643-fix-relations`

This migration has been generated by kiralybalint <balint.kiraly@cogito.study> at 8/6/2019, 1:26:43 PM.
You can check out the [state of the datamodel](./datamodel.prisma) after the migration.

## Database Steps

```sql
CREATE TABLE "public"."Department"("id" text NOT NULL  ,"name" text NOT NULL DEFAULT '' ,"description" text NOT NULL DEFAULT '' ,"createdAt" timestamp(3) NOT NULL  ,"updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,"deletedAt" timestamp(3)   ,PRIMARY KEY ("id"));

CREATE TABLE "public"."Institute"("id" text NOT NULL  ,"name" text NOT NULL DEFAULT '' ,"createdAt" timestamp(3) NOT NULL  ,"updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,"deletedAt" timestamp(3)   ,PRIMARY KEY ("id"));

CREATE TABLE "public"."Note"("id" text NOT NULL  ,"content" text NOT NULL DEFAULT '' ,"contentHTML" text NOT NULL DEFAULT '' ,"title" text NOT NULL DEFAULT '' ,"number" integer NOT NULL DEFAULT 0 ,"description" text   ,"noteCategory" text NOT NULL DEFAULT 'NOTE' ,"createdAt" timestamp(3) NOT NULL  ,"updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,"deletedAt" timestamp(3)   ,PRIMARY KEY ("id"));

CREATE TABLE "public"."NoteComment"("id" text NOT NULL  ,"content" text NOT NULL DEFAULT '' ,"position" text NOT NULL DEFAULT '' ,"createdAt" timestamp(3) NOT NULL  ,"updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,"deletedAt" timestamp(3)   ,PRIMARY KEY ("id"));

CREATE TABLE "public"."NoteCommentThread"("id" text NOT NULL  ,"createdAt" timestamp(3) NOT NULL  ,"updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,"deletedAt" timestamp(3)   ,PRIMARY KEY ("id"));

CREATE TABLE "public"."NoteHighlight"("id" text NOT NULL  ,"position" text NOT NULL DEFAULT '' ,"createdAt" timestamp(3) NOT NULL  ,"updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,"deletedAt" timestamp(3)   ,PRIMARY KEY ("id"));

CREATE TABLE "public"."PasswordToken"("id" text NOT NULL  ,"token" text NOT NULL DEFAULT '' ,"createdAt" timestamp(3) NOT NULL  ,"updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,"deletedAt" timestamp(3)   ,PRIMARY KEY ("id"));

CREATE TABLE "public"."Subject"("id" text NOT NULL  ,"code" text NOT NULL DEFAULT '' ,"name" text NOT NULL DEFAULT '' ,"description" text NOT NULL DEFAULT '' ,"createdAt" timestamp(3) NOT NULL  ,"updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,"deletedAt" timestamp(3)   ,PRIMARY KEY ("id"));

CREATE TABLE "public"."SubjectInformation"("id" text NOT NULL  ,"title" text NOT NULL DEFAULT '' ,"subtitle" text   ,"content" text NOT NULL DEFAULT '' ,"createdAt" timestamp(3) NOT NULL  ,"updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,"deletedAt" timestamp(3)   ,PRIMARY KEY ("id"));

CREATE TABLE "public"."Suggestion"("id" text NOT NULL  ,"delta" text NOT NULL DEFAULT '' ,"approvedAt" timestamp(3)   ,"createdAt" timestamp(3) NOT NULL  ,"updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,"deletedAt" timestamp(3)   ,PRIMARY KEY ("id"));

CREATE TABLE "public"."User"("id" text NOT NULL  ,"email" text NOT NULL DEFAULT '' ,"password" text NOT NULL DEFAULT '' ,"profilePictureURL" text   ,"firstName" text NOT NULL DEFAULT '' ,"lastName" text NOT NULL DEFAULT '' ,"phoneNumber" text NOT NULL DEFAULT '' ,"identifier" text NOT NULL DEFAULT '' ,"createdAt" timestamp(3) NOT NULL  ,"updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,"deletedAt" timestamp(3)   ,PRIMARY KEY ("id"));

CREATE TABLE "public"."UserRole"("id" text NOT NULL  ,"name" text NOT NULL DEFAULT '' ,"type" text NOT NULL DEFAULT 'USER' ,"createdAt" timestamp(3) NOT NULL  ,"updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,"deletedAt" timestamp(3)   ,PRIMARY KEY ("id"));

CREATE TABLE "public"."_InstituteUsers"("A" text NOT NULL  REFERENCES "public"."Institute"("id"),"B" text NOT NULL  REFERENCES "public"."User"("id"));

CREATE TABLE "public"."_NoteAuthors"("A" text NOT NULL  REFERENCES "public"."Note"("id"),"B" text NOT NULL  REFERENCES "public"."User"("id"));

CREATE TABLE "public"."_NoteLikes"("A" text NOT NULL  REFERENCES "public"."Note"("id"),"B" text NOT NULL  REFERENCES "public"."User"("id"));

CREATE TABLE "public"."_CommentLikes"("A" text NOT NULL  REFERENCES "public"."NoteComment"("id"),"B" text NOT NULL  REFERENCES "public"."User"("id"));

CREATE TABLE "public"."_SubjectTeachers"("A" text NOT NULL  REFERENCES "public"."Subject"("id"),"B" text NOT NULL  REFERENCES "public"."User"("id"));

CREATE TABLE "public"."_SubjectStudents"("A" text NOT NULL  REFERENCES "public"."Subject"("id"),"B" text NOT NULL  REFERENCES "public"."User"("id"));

CREATE TABLE "public"."_SuggestionLikes"("A" text NOT NULL  REFERENCES "public"."Suggestion"("id"),"B" text NOT NULL  REFERENCES "public"."User"("id"));

ALTER TABLE "public"."Department" ADD COLUMN "leader" text NOT NULL  REFERENCES "public"."User"("id"),ADD COLUMN "institute" text NOT NULL  REFERENCES "public"."Institute"("id");

ALTER TABLE "public"."Note" ADD COLUMN "subject" text NOT NULL  REFERENCES "public"."Subject"("id");

ALTER TABLE "public"."NoteComment" ADD COLUMN "author" text NOT NULL  REFERENCES "public"."User"("id"),ADD COLUMN "thread" text NOT NULL  REFERENCES "public"."NoteCommentThread"("id"),ADD COLUMN "threadReply" text   REFERENCES "public"."NoteCommentThread"("id");

ALTER TABLE "public"."NoteCommentThread" ADD COLUMN "note" text NOT NULL  REFERENCES "public"."Note"("id");

ALTER TABLE "public"."NoteHighlight" ADD COLUMN "note" text NOT NULL  REFERENCES "public"."Note"("id"),ADD COLUMN "user" text NOT NULL  REFERENCES "public"."User"("id");

ALTER TABLE "public"."PasswordToken" ADD COLUMN "user" text NOT NULL  REFERENCES "public"."User"("id");

ALTER TABLE "public"."Subject" ADD COLUMN "department" text NOT NULL  REFERENCES "public"."Department"("id");

ALTER TABLE "public"."SubjectInformation" ADD COLUMN "subject" text NOT NULL  REFERENCES "public"."Subject"("id");

ALTER TABLE "public"."Suggestion" ADD COLUMN "note" text NOT NULL  REFERENCES "public"."Note"("id"),ADD COLUMN "approvedBy" text   REFERENCES "public"."User"("id"),ADD COLUMN "author" text NOT NULL  REFERENCES "public"."User"("id");

ALTER TABLE "public"."User" ADD COLUMN "role" text NOT NULL  REFERENCES "public"."UserRole"("id");
```

## Changes

```diff
diff --git datamodel.mdl datamodel.mdl
migration 20190805165933-init-schema..20190806132643-fix-relations
--- datamodel.dml
+++ datamodel.dml
@@ -51,15 +51,14 @@
   title          String
   number         Int
   description    String?
   noteCategory   NoteCategory
-  suggestions    Suggestion          @relation(name: "NoteSuggestions")
+  suggestions    Suggestion[]        @relation(name: "NoteSuggestions")
   commentThreads NoteCommentThread[] @relation(name: "NoteCommentThreads")
   authors        User[]              @relation(name: "NoteAuthors")
   likes          User[]              @relation(name: "NoteLikes")
   highlights     NoteHighlight[]     @relation(name: "NoteHighlights")
-  topHighlights  TopNoteHighlight[]  @relation(name: "NoteTopHighlights")
-  subject        Subject[]           @relation(name: "SubjectNotes")
+  subject        Subject             @relation(name: "SubjectNotes")
   createdAt      DateTime            @default(now())
   updatedAt      DateTime            @updatedAt
   deletedAt      DateTime?
 }
@@ -135,25 +134,17 @@
 model Suggestion {
   id         String    @default(cuid()) @id @unique
   delta      String
   approvedAt DateTime?
+  likes      User[]    @relation(name: "SuggestionLikes")
   approvedBy User?     @relation(name: "SuggestionApprovedBy")
   note       Note      @relation(name: "NoteSuggestions")
   author     User      @relation(name: "SuggestionAuthor")
   createdAt  DateTime  @default(now())
   updatedAt  DateTime  @updatedAt
   deletedAt  DateTime?
 }
-model TopNoteHighlight {
-  id        String    @default(cuid()) @id @unique
-  position  String
-  note      Note      @relation(name: "NoteTopHighlights")
-  createdAt DateTime  @default(now())
-  updatedAt DateTime  @updatedAt
-  deletedAt DateTime?
-}
-
 model User {
   id                  String          @default(cuid()) @id @unique
   email               String          @unique
   password            String
@@ -166,16 +157,17 @@
   notes               Note[]          @relation(name: "NoteAuthors")
   noteHighlights      NoteHighlight[] @relation(name: "UserNoteHighlights")
   suggestions         Suggestion[]    @relation(name: "SuggestionAuthor")
   approvedSuggestions Suggestion[]    @relation(name: "SuggestionApprovedBy")
-  teach               Subject[]       @relation(name: "SubjectTeachers")
-  study               Subject[]       @relation(name: "SubjectStudents")
+  teachedSubjects     Subject[]       @relation(name: "SubjectTeachers")
+  studiedSubjects     Subject[]       @relation(name: "SubjectStudents")
   noteLikes           Note[]          @relation(name: "NoteLikes")
   comments            NoteComment[]   @relation(name: "CommentAuthor")
   commentLikes        NoteComment[]   @relation(name: "CommentLikes")
+  suggestionLikes     Suggestion[]    @relation(name: "SuggestionLikes")
   passwordToken       PasswordToken   @relation(name: "PasswordTokenUser")
   departments         Department[]    @relation(name: "DepartmentLeader")
-  institute           Institute[]     @relation(name: "InstituteUsers")
+  institutes          Institute[]     @relation(name: "InstituteUsers")
   createdAt           DateTime        @default(now())
   updatedAt           DateTime        @updatedAt
   deletedAt           DateTime?
 }
```

## Photon Usage

You can use a specific Photon built for this migration (20190806132643-fix-relations)
in your `before` or `after` migration script like this:

```ts
import Photon from '@generated/photon/20190806132643-fix-relations'

const photon = new Photon()

async function main() {
  const result = await photon.users()
  console.dir(result, { depth: null })
}

main()

```
