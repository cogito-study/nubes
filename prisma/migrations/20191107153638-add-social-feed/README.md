# Migration `20191107153638-add-social-feed`

This migration has been generated by kiralybalint <balint.kiraly@cogito.study> at 11/7/2019, 3:36:38 PM.
You can check out the [state of the datamodel](./datamodel.prisma) after the migration.

## Database Steps

```sql
CREATE TABLE "public"."Post" (
  "author" text   REFERENCES "public"."User"("id") ON DELETE SET NULL,
  "content" text NOT NULL DEFAULT '' ,
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "deletedAt" timestamp(3)   ,
  "id" text NOT NULL  ,
  "subject" text   REFERENCES "public"."Subject"("id") ON DELETE SET NULL,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "public"."PostComment" (
  "author" text   REFERENCES "public"."User"("id") ON DELETE SET NULL,
  "content" text NOT NULL DEFAULT '' ,
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "deletedAt" timestamp(3)   ,
  "id" text NOT NULL  ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "public"."PostCommentPermission" (
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "deletedAt" timestamp(3)   ,
  "id" text NOT NULL  ,
  "type" text NOT NULL DEFAULT 'CREATE_POSTCOMMENT' ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "public"."PostPermission" (
  "createdAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  "deletedAt" timestamp(3)   ,
  "id" text NOT NULL  ,
  "type" text NOT NULL DEFAULT 'CREATE_POSTCOMMENT' ,
  "updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,
  PRIMARY KEY ("id")
);

CREATE TABLE "public"."_NoteCommentLikers" (
  "A" text   REFERENCES "public"."NoteComment"("id") ON DELETE CASCADE,
  "B" text   REFERENCES "public"."User"("id") ON DELETE CASCADE
);

CREATE TABLE "public"."_PostLikers" (
  "A" text   REFERENCES "public"."Post"("id") ON DELETE CASCADE,
  "B" text   REFERENCES "public"."User"("id") ON DELETE CASCADE
);

CREATE TABLE "public"."_PostPermissions" (
  "A" text   REFERENCES "public"."Post"("id") ON DELETE CASCADE,
  "B" text   REFERENCES "public"."PostPermission"("id") ON DELETE CASCADE
);

CREATE TABLE "public"."_PostCommentPermissions" (
  "A" text   REFERENCES "public"."PostComment"("id") ON DELETE CASCADE,
  "B" text   REFERENCES "public"."PostCommentPermission"("id") ON DELETE CASCADE
);

ALTER TABLE "public"."_CommentLikers" DROP COLUMN "A",
ADD COLUMN "A" text   REFERENCES "public"."PostComment"("id") ON DELETE CASCADE;

ALTER TABLE "public"."Permission" ADD COLUMN "postCommentPermission" text   REFERENCES "public"."PostCommentPermission"("id") ON DELETE SET NULL,
ADD COLUMN "postPermission" text   REFERENCES "public"."PostPermission"("id") ON DELETE SET NULL;

ALTER TABLE "public"."PostComment" ADD COLUMN "post" text   REFERENCES "public"."Post"("id") ON DELETE SET NULL;

CREATE UNIQUE INDEX "Post.id" ON "public"."Post"("id")

CREATE UNIQUE INDEX "PostComment.id" ON "public"."PostComment"("id")

CREATE UNIQUE INDEX "PostCommentPermission.id" ON "public"."PostCommentPermission"("id")

CREATE UNIQUE INDEX "PostPermission.id" ON "public"."PostPermission"("id")

CREATE UNIQUE INDEX "_NoteCommentLikers_AB_unique" ON "public"."_NoteCommentLikers"("A","B")

CREATE UNIQUE INDEX "_PostLikers_AB_unique" ON "public"."_PostLikers"("A","B")

CREATE UNIQUE INDEX "_PostPermissions_AB_unique" ON "public"."_PostPermissions"("A","B")

CREATE UNIQUE INDEX "_PostCommentPermissions_AB_unique" ON "public"."_PostCommentPermissions"("A","B")
```

## Changes

```diff
diff --git datamodel.mdl datamodel.mdl
migration 20191029100349-fix-permissions..20191107153638-add-social-feed
--- datamodel.dml
+++ datamodel.dml
@@ -76,10 +76,10 @@
 model NoteComment {
   id          String                  @default(cuid()) @id @unique
   content     String
-  author      User                    @relation(name: "CommentAuthor")
-  likers      User[]                  @relation(name: "CommentLikers")
+  author      User                    @relation(name: "NoteCommentAuthor")
+  likers      User[]                  @relation(name: "NoteCommentLikers")
   thread      NoteCommentThread?      @relation(name: "NoteCommentThreadComment")
   threadReply NoteCommentThread?      @relation(name: "NoteCommentThreadReplies")
   permissions NoteCommentPermission[] @relation(name: "NoteCommentPermissions")
   createdAt   DateTime                @default(now())
@@ -128,8 +128,9 @@
   teachers     User[]               @relation(name: "SubjectTeachers")
   students     User[]               @relation(name: "SubjectStudents")
   informations SubjectInformation[] @relation(name: "SubjectInformations")
   notes        Note[]               @relation(name: "SubjectNotes")
+  posts        Post[]               @relation(name: "SubjectPosts")
   language     Language             @relation(name: "SubjectLanguage")
   permissions  SubjectPermission[]  @relation(name: "SubjectPermissions")
   createdAt    DateTime             @default(now())
   updatedAt    DateTime             @updatedAt
@@ -183,10 +184,14 @@
   approvedSuggestions Suggestion[]        @relation(name: "SuggestionApprovedBy")
   teachedSubjects     Subject[]           @relation(name: "SubjectTeachers")
   studiedSubjects     Subject[]           @relation(name: "SubjectStudents")
   likedNotes          Note[]              @relation(name: "NoteLikers")
-  comments            NoteComment[]       @relation(name: "CommentAuthor")
-  likedComments       NoteComment[]       @relation(name: "CommentLikers")
+  noteComments        NoteComment[]       @relation(name: "NoteCommentAuthor")
+  postComments        PostComment[]       @relation(name: "PostCommentAuthor")
+  likedNoteComments   NoteComment[]       @relation(name: "NoteCommentLikers")
+  likedComments       PostComment[]       @relation(name: "CommentLikers")
+  likedPosts          Post[]              @relation(name: "PostLikers")
+  posts               Post[]              @relation(name: "PostAuthor")
   likedSuggestions    Suggestion[]        @relation(name: "SuggestionLikers")
   passwordToken       PasswordToken?      @relation(name: "PasswordTokenUser")
   departments         Department[]        @relation(name: "DepartmentLeader")
   institutes          Institute[]         @relation(name: "InstituteUsers")
@@ -197,8 +202,33 @@
   updatedAt           DateTime            @updatedAt
   deletedAt           DateTime?
 }
+model Post {
+  id          String           @default(cuid()) @id @unique
+  content     String
+  author      User             @relation(name: "PostAuthor")
+  subject     Subject          @relation(name: "SubjectPosts")
+  likers      User[]           @relation(name: "PostLikers")
+  comments    PostComment[]    @relation(name: "PostPostComments")
+  permissions PostPermission[] @relation(name: "PostPermissions")
+  createdAt   DateTime         @default(now())
+  updatedAt   DateTime         @updatedAt
+  deletedAt   DateTime?
+}
+
+model PostComment {
+  id          String                  @default(cuid()) @id @unique
+  content     String
+  author      User                    @relation(name: "PostCommentAuthor")
+  post        Post                    @relation(name: "PostPostComments")
+  likers      User[]                  @relation(name: "CommentLikers")
+  permissions PostCommentPermission[] @relation(name: "PostCommentPermissions")
+  createdAt   DateTime                @default(now())
+  updatedAt   DateTime                @updatedAt
+  deletedAt   DateTime?
+}
+
 model ActivationToken {
   id        String   @default(cuid()) @id @unique
   user      User
   token     String   @unique
@@ -231,8 +261,9 @@
 }
 enum DepartmentPermissionType {
   UPDATE_DEPARTMENT
+  READ_DEPARTMENT
   DELETE_DEPARTMENT
   CREATE_SUBJECT
 }
@@ -314,8 +345,10 @@
   users                        User[]                        @relation(name: "UserPermissions")
   departmentPermission         DepartmentPermission?         @relation
   institutePermission          InstitutePermission?          @relation
   notePermission               NotePermission?               @relation
+  postPermission               PostPermission?               @relation
+  postCommentPermission        PostCommentPermission?        @relation
   noteCommentPermission        NoteCommentPermission?        @relation
   noteCommentThreadPermission  NoteCommentThreadPermission?  @relation
   noteHighlightPermission      NoteHighlightPermission?      @relation
   subjectPermission            SubjectPermission?            @relation
@@ -323,8 +356,39 @@
   suggestionPermission         SuggestionPermission?         @relation
   userPermission               UserPermission?               @relation
 }
+model PostCommentPermission {
+  id        String             @default(cuid()) @id @unique
+  type      PostPermissionType
+  objects   PostComment[]      @relation(name: "PostCommentPermissions")
+  createdAt DateTime           @default(now())
+  updatedAt DateTime           @updatedAt
+  deletedAt DateTime?
+}
+
+enum PostCommentPermissionType {
+  UPDATE_POSTCOMMENT
+  DELETE_POSTCOMMENT
+  READ_POSTCOMMENT
+}
+
+model PostPermission {
+  id        String             @default(cuid()) @id @unique
+  type      PostPermissionType
+  objects   Post[]             @relation(name: "PostPermissions")
+  createdAt DateTime           @default(now())
+  updatedAt DateTime           @updatedAt
+  deletedAt DateTime?
+}
+
+enum PostPermissionType {
+  CREATE_POSTCOMMENT
+  UPDATE_POST
+  DELETE_POST
+  READ_POST
+}
+
 model SubjectPermission {
   id        String                @default(cuid()) @id @unique
   type      SubjectPermissionType
   objects   Subject[]             @relation(name: "SubjectPermissions")
@@ -333,11 +397,13 @@
   deletedAt DateTime?
 }
 enum SubjectPermissionType {
+  CREATE_POST
   CREATE_SUBJECT_INFORMATION
   UPDATE_SUBJECT
   DELETE_SUBJECT
+  READ_SUBJECT
   CREATE_NOTE
 }
 model SubjectInformationPermission {
@@ -349,8 +415,9 @@
   deletedAt DateTime?
 }
 enum SubjectInformationPermissionType {
+  READ_SUBJECT_INFORMATION
   UPDATE_SUBJECT_INFORMATION
   DELETE_SUBJECT_INFORMATION
 }
@@ -364,8 +431,9 @@
 }
 enum SuggestionPermissionType {
   UPDATE_SUGGESTION
+  READ_SUGGESTION
   DELETE_SUGGESTION
   APPROVE_SUGGESTION
   REJECT_SUGGESTION
 }
```

## Photon Usage

You can use a specific Photon built for this migration (20191107153638-add-social-feed)
in your `before` or `after` migration script like this:

```ts
import Photon from '@generated/photon/20191107153638-add-social-feed'

const photon = new Photon()

async function main() {
  const result = await photon.users()
  console.dir(result, { depth: null })
}

main()

```
